{% extends 'base.html' %} {% block content %}
<style>
  /* Custom media query for screens between 500px and 640px */
  @media (min-width: 500px) and (max-width: 640px) {
    /* Scale down the entire content area */
    .content-area {
      transform: scale(0.85);
      transform-origin: top center;
      width: 117.65%; /* Counteract the scaling to maintain width */
      margin-left: -8.825%; /* Center the scaled content */
      margin-right: -8.825%;
    }

    /* Adjust the header to not scale */
    header {
      transform: none !important;
      width: 100% !important;
      margin-left: 0 !important;
      margin-right: 0 !important;
    }
  }
</style>

<div class="min-h-screen">
  <header class="bg-white/90 backdrop-blur-sm shadow-lg sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-2 sm:px-3 py-1.5 sm:py-2 sm:px-4 lg:px-8">
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-1 sm:space-x-2">
          <i
            data-lucide="heart"
            class="h-4 w-4 sm:h-5 sm:w-6 md:h-6 md:w-8 text-yellow-500"
          ></i>
          <span
            class="text-base sm:text-lg md:text-xl lg:text-2xl font-bold bg-gradient-to-r from-yellow-500 to-orange-600 bg-clip-text text-transparent"
          >
            Sharodiya-Swipe
          </span>
        </div>
        <div class="flex items-center space-x-1 sm:space-x-2 md:space-x-4">
          <a
            href="{{ url_for('chat_list') }}"
            class="p-1 sm:p-1.5 text-gray-600 hover:text-yellow-600 transition-colors relative"
          >
            <i
              data-lucide="message-circle"
              class="h-3 w-3 sm:h-4 sm:w-4 md:h-5 md:w-5 lg:h-6 lg:w-6"
            ></i>
            {% if unread_chat_count > 0 %}
            <span
              class="absolute top-0 right-0 h-3 w-3 sm:h-4 sm:w-4 rounded-full bg-red-500 flex items-center justify-center text-white text-[8px] sm:text-xs font-bold"
            >
              {{ unread_chat_count }}
            </span>
            {% endif %}
          </a>
          <a
            href="{{ url_for('edit_profile') }}"
            class="p-1 sm:p-1.5 text-gray-600 hover:text-yellow-600 transition-colors"
          >
            <i
              data-lucide="settings"
              class="h-3 w-3 sm:h-4 sm:w-4 md:h-5 md:w-5 lg:h-6 lg:w-6"
            ></i>
          </a>
          <a
            href="{{ url_for('logout') }}"
            class="p-1 sm:p-1.5 text-gray-600 hover:text-yellow-600 transition-colors"
          >
            <i
              data-lucide="log-out"
              class="h-3 w-3 sm:h-4 sm:w-4 md:h-5 md:w-5 lg:h-6 lg:w-6"
            ></i>
          </a>
        </div>
      </div>
    </div>
  </header>

  <div class="content-area">
    <div
      class="max-w-7xl mx-auto px-2 sm:px-3 py-3 sm:py-4 md:py-6 lg:py-8 sm:px-4 lg:px-8"
    >
      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %}
      <div class="mb-2 sm:mb-3 md:mb-4 lg:mb-6">
        {% for category, message in messages %}
        <div
          class="p-1.5 sm:p-2 md:p-3 lg:p-4 rounded-md {{ 'bg-green-100 text-green-800' if category == 'success' else 'bg-red-100 text-red-800' }}"
        >
          <p class="text-xs sm:text-sm md:text-base">{{ message }}</p>
        </div>
        {% endfor %}
      </div>
      {% endif %} {% endwith %}

      <div
        class="grid grid-cols-1 lg:grid-cols-3 gap-3 sm:gap-4 md:gap-5 lg:gap-8"
      >
        <!-- Left Column - Profile Info -->
        <div class="lg:col-span-1">
          <div
            class="bg-white/90 backdrop-blur-sm rounded-lg sm:rounded-xl md:rounded-2xl lg:rounded-3xl shadow-lg p-2 sm:p-3 md:p-4 lg:p-6"
          >
            <div class="text-center">
              <img
                src="{{ profile.photos[0] if profile.photos else 'https://images.pexels.com/photos/220453/pexels-photo-220453.jpeg?auto=compress&cs=tinysrgb&w=400&h=400&fit=crop&crop=face' }}"
                loading="lazy"
                alt="Profile"
                class="w-16 h-16 sm:w-20 sm:h-20 md:w-24 md:h-24 lg:w-32 lg:h-32 rounded-full object-cover mx-auto mb-2 sm:mb-3 md:mb-4 ring-2 sm:ring-3 md:ring-4 ring-yellow-200 cursor-pointer"
                onclick="openLightbox('{{ profile.photos[0] if profile.photos else 'https://images.pexels.com/photos/220453/pexels-photo-220453.jpeg?auto=compress&cs=tinysrgb&w=400&h=400&fit=crop&crop=face' }}')"
              />
              <h2
                class="text-base sm:text-lg md:text-xl lg:text-2xl font-bold text-gray-900"
              >
                {{ profile.name }}
              </h2>
              <p class="text-gray-600 text-xs sm:text-sm md:text-base">
                {{ profile.age }} years old
              </p>
              <p class="text-gray-600 text-xs sm:text-sm md:text-base">
                {{ profile.location }}
              </p>
            </div>

            <div class="mt-2 sm:mt-3 md:mt-4 lg:mt-6">
              <h3
                class="text-xs sm:text-sm md:text-base lg:text-lg font-semibold text-gray-900 mb-1 sm:mb-2 md:mb-3"
              >
                About Me
              </h3>
              <p
                class="text-gray-600 text-xs sm:text-sm leading-relaxed break-words overflow-hidden line-clamp-3 sm:line-clamp-4"
              >
                {{ profile.bio }}
              </p>
            </div>

            <div class="mt-2 sm:mt-3 md:mt-4 lg:mt-6">
              <h3
                class="text-xs sm:text-sm md:text-base lg:text-lg font-semibold text-gray-900 mb-1 sm:mb-2 md:mb-3"
              >
                Interests
              </h3>
              <div class="flex flex-wrap gap-0.5 sm:gap-1 md:gap-1.5 lg:gap-2">
                {% for interest in profile.interests %}
                <span
                  class="px-1 sm:px-1.5 md:px-2 lg:px-3 py-0.5 sm:py-1 bg-yellow-100 text-yellow-800 rounded-full text-[10px] sm:text-xs md:text-sm"
                >
                  {{ interest }}
                </span>
                {% endfor %}
              </div>
            </div>

            <!-- Preferences Section -->
            <div class="mt-3 sm:mt-4 md:mt-5 lg:mt-6">
              <h3
                class="text-xs sm:text-sm md:text-base lg:text-lg font-semibold text-gray-900 mb-1 sm:mb-2 md:mb-3"
              >
                My Preferences
              </h3>
              <ul
                class="space-y-1 sm:space-y-1.5 md:space-y-2 text-xs sm:text-sm text-gray-700"
              >
                {% if profile.aesthetics %}
                <li>
                  <span class="font-medium text-gray-900">Aesthetics:</span>
                  {{ profile.aesthetics }}
                </li>
                {% endif %} {% if profile.relationship %}
                <li>
                  <span class="font-medium text-gray-900">Relationship:</span>
                  {{ profile.relationship }}
                </li>
                {% endif %} {% if profile.fun_option %}
                <li>
                  <span class="font-medium text-gray-900">Which Paglu? </span>
                  {{ profile.fun_option }}
                </li>
                {% endif %} {% if profile.hangout %}
                <li>
                  <span class="font-medium text-gray-900">Hangout:</span>
                  {{ profile.hangout }}
                </li>
                {% endif %} {% if profile.looking_for %}
                <li>
                  <span class="font-medium text-gray-900">Looking For:</span>
                  {{ profile.looking_for }}
                </li>
                {% endif %}
              </ul>
            </div>

            <button
              id="add-photos-btn"
              class="w-full mt-2 sm:mt-3 md:mt-4 lg:mt-6 py-1.5 sm:py-2 md:py-2.5 lg:py-3 bg-gradient-to-r from-yellow-500 to-orange-600 text-white rounded-md sm:rounded-lg md:rounded-xl font-semibold hover:from-yellow-600 hover:to-orange-700 transition-all text-xs sm:text-sm md:text-base"
            >
              Add Photos
            </button>
          </div>
        </div>

        <!-- Right Column - Main Content -->
        <div class="lg:col-span-2">
          <div class="space-y-2 sm:space-y-3 md:space-y-4 lg:space-y-6">
            <!-- Stats Cards -->
            <div class="grid grid-cols-3 gap-1.5 sm:gap-2 md:gap-3 lg:gap-4">
              <!-- Matches -->
              <div
                onclick="openPopup('matches')"
                class="cursor-pointer bg-white/90 backdrop-blur-sm rounded-md sm:rounded-lg md:rounded-xl lg:rounded-2xl shadow-lg p-2 sm:p-3 md:p-4 lg:p-6 text-center hover:shadow-xl transition"
              >
                <i
                  data-lucide="users"
                  class="h-4 w-4 sm:h-5 sm:w-5 md:h-6 sm:w-6 lg:h-8 lg:w-8 text-yellow-500 mx-auto mb-1"
                ></i>
                <div
                  class="text-base sm:text-lg md:text-xl lg:text-2xl font-bold text-gray-900"
                >
                  {{ match_count }}
                </div>
                <div class="text-gray-600 text-[10px] sm:text-xs md:text-sm">
                  Matches
                </div>
              </div>
              <!-- Messages -->
              <div
                onclick="openPopup('messages')"
                class="cursor-pointer bg-white/90 backdrop-blur-sm rounded-md sm:rounded-lg md:rounded-xl lg:rounded-2xl shadow-lg p-2 sm:p-3 md:p-4 lg:p-6 text-center hover:shadow-xl transition"
              >
                <i
                  data-lucide="message-circle"
                  class="h-4 w-4 sm:h-5 sm:w-5 md:h-6 sm:w-6 lg:h-8 lg:w-8 text-orange-500 mx-auto mb-1"
                ></i>
                <div
                  class="text-base sm:text-lg md:text-xl lg:text-2xl font-bold text-gray-900"
                >
                  {{ messages_count }}
                </div>
                <div class="text-gray-600 text-[10px] sm:text-xs md:text-sm">
                  Messages
                </div>
              </div>
              <!-- Likes -->
              <div
                onclick="openPopup('likes')"
                class="cursor-pointer bg-white/90 backdrop-blur-sm rounded-md sm:rounded-lg md:rounded-xl lg:rounded-2xl shadow-lg p-2 sm:p-3 md:p-4 lg:p-6 text-center hover:shadow-xl transition"
              >
                <i
                  data-lucide="star"
                  class="h-4 w-4 sm:h-5 sm:w-5 md:h-6 sm:w-6 lg:h-8 lg:w-8 text-yellow-500 mx-auto mb-1"
                ></i>
                <div
                  class="text-base sm:text-lg md:text-xl lg:text-2xl font-bold text-gray-900"
                >
                  {{ likes_count }}
                </div>
                <div class="text-gray-600 text-[10px] sm:text-xs md:text-sm">
                  Likes
                </div>
              </div>
            </div>

            <!-- Welcome Section -->
            <div
              class="bg-white/90 backdrop-blur-sm rounded-md sm:rounded-lg md:rounded-xl lg:rounded-2xl shadow-lg p-3 sm:p-4 md:p-5 lg:p-6"
            >
              <div class="text-center">
                <h1
                  class="text-lg sm:text-xl md:text-2xl lg:text-3xl font-bold text-gray-900 mb-2 sm:mb-3 md:mb-4"
                >
                  Welcome to Sharodiya-Swipe, {{ profile.name }}! ðŸŽ‰
                </h1>
                <p
                  class="text-gray-600 text-xs sm:text-sm md:text-base mb-2 sm:mb-3 md:mb-4 lg:mb-6 px-1"
                >
                  Your profile is complete and you're ready to start connecting
                  with amazing people in your area.
                </p>
                <div
                  class="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3 md:gap-4 px-1 sm:px-0"
                >
                  <a
                    href="{{ url_for('matching') }}"
                    class="px-2 sm:px-3 md:px-4 lg:px-6 py-1.5 sm:py-2 md:py-2.5 lg:py-3 bg-gradient-to-r from-yellow-500 to-orange-600 text-white rounded-md sm:rounded-lg md:rounded-xl font-semibold hover:from-yellow-600 hover:to-orange-700 transform hover:scale-105 transition-all shadow-lg text-xs sm:text-sm md:text-base"
                  >
                    Start Matching
                  </a>
                  <a
                    href="{{ url_for('see_other') }}"
                    class="px-2 sm:px-3 md:px-4 lg:px-6 py-1.5 sm:py-2 md:py-2.5 lg:py-3 border-2 border-yellow-500 text-yellow-600 rounded-md sm:rounded-lg md:rounded-xl font-semibold hover:bg-yellow-50 transition-colors text-xs sm:text-sm md:text-base"
                  >
                    Browse Profiles
                  </a>
                </div>
              </div>
            </div>

            <!-- Recent Activity -->
            <div
              class="bg-white p-2 sm:p-3 md:p-4 lg:p-6 rounded-md sm:rounded-lg md:rounded-xl lg:rounded-2xl shadow-lg"
            >
              <h3
                class="text-sm sm:text-base md:text-lg lg:text-2xl font-bold text-slate-800 mb-1 sm:mb-2 md:mb-3 lg:mb-4"
              >
                Recent Activity
              </h3>
              <ul
                id="recent-activity-list"
                class="space-y-1 sm:space-y-2 md:space-y-3 lg:space-y-4"
              >
                {% for activity in recent_activity %}
                <li
                  class="flex items-center space-x-1 sm:space-x-2 md:space-x-3 lg:space-x-4 bg-slate-50 p-1.5 sm:p-2 md:p-3 lg:p-4 rounded-md sm:rounded-lg transition duration-200 hover:bg-slate-100"
                >
                  <div
                    class="w-5 h-5 sm:w-6 sm:h-6 md:w-8 md:h-8 lg:w-10 lg:h-10 flex items-center justify-center rounded-full text-white text-[10px] sm:text-xs md:text-sm lg:text-base flex-shrink-0 {% if activity.type == 'message' %} bg-blue-100 text-blue-500 {% elif activity.type == 'like' %} bg-yellow-100 text-yellow-500 {% elif activity.type == 'match' %} bg-green-100 text-green-500 {% endif %}"
                  >
                    {% if activity.type == "message" %}
                    <i
                      data-lucide="message-circle"
                      class="h-2 w-2 sm:h-3 sm:w-3 md:h-4 md:w-4 lg:h-5 lg:w-5"
                    ></i>
                    {% elif activity.type == "like" %}
                    <i
                      data-lucide="heart"
                      class="h-2 w-2 sm:h-3 sm:w-3 md:h-4 md:w-4 lg:h-5 lg:w-5"
                    ></i>
                    {% elif activity.type == "match" %}
                    <i
                      data-lucide="users"
                      class="h-2 w-2 sm:h-3 sm:w-3 md:h-4 md:w-4 lg:h-5 lg:w-5"
                    ></i>
                    {% endif %}
                  </div>
                  <div class="flex-1 min-w-0">
                    <a
                      href="{{ activity.link }}"
                      class="text-slate-700 font-medium text-xs sm:text-sm md:text-base block truncate hover:text-yellow-600"
                    >
                      {{ activity.message }}
                    </a>
                    <span
                      class="text-[10px] sm:text-xs text-slate-500 block mt-0.5"
                    >
                      {{ activity.timestamp | humanize_datetime }}
                    </span>
                  </div>
                </li>
                {% endfor %}
              </ul>
              {% if recent_activity|length > 3 %}
              <button
                id="toggle-activity-btn"
                class="mt-1 sm:mt-2 md:mt-3 lg:mt-4 w-full py-1.5 sm:py-2 md:py-2.5 lg:py-3 bg-gradient-to-r from-yellow-500 to-orange-600 text-white rounded-md sm:rounded-lg md:rounded-xl font-semibold hover:from-yellow-600 hover:to-orange-700 transition-all text-xs sm:text-sm md:text-base"
              >
                Show More
              </button>
              {% endif %}
            </div>

            <!-- Photos Section -->
            <div
              class="bg-white/90 backdrop-blur-sm rounded-md sm:rounded-lg md:rounded-xl lg:rounded-2xl shadow-lg p-2 sm:p-3 md:p-4 lg:p-6"
            >
              <h3
                class="text-sm sm:text-base md:text-lg lg:text-xl font-bold text-gray-900 mb-1 sm:mb-2 md:mb-3 lg:mb-4"
              >
                Your Photos
              </h3>
              <div
                class="grid grid-cols-2 sm:grid-cols-3 gap-1 sm:gap-1.5 md:gap-2 lg:gap-4"
              >
                {% for photo in profile.photos %}
                <div class="relative group aspect-w-1 aspect-h-1">
                  <img
                    src="{{ photo }}"
                    alt="User photo"
                    class="w-full h-full object-cover rounded-md sm:rounded-lg md:rounded-xl shadow-md cursor-pointer"
                    onclick="openLightbox('{{ photo }}')"
                  />
                  <form
                    method="POST"
                    action="{{ url_for('delete_photo') }}"
                    class="absolute top-1 sm:top-1.5 md:top-2 right-1 sm:right-1.5 md:right-2 hidden group-hover:block"
                  >
                    <input type="hidden" name="photo_url" value="{{ photo }}" />
                    <button
                      type="submit"
                      class="bg-red-500 text-white rounded-full p-0.5 sm:p-1 md:p-1.5 shadow-md hover:bg-red-600 transition"
                    >
                      <i
                        data-lucide="trash-2"
                        class="w-2 h-2 sm:w-2.5 sm:h-2.5 md:w-3 md:h-3 lg:w-4 lg:h-4"
                      ></i>
                    </button>
                  </form>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Photos Modal -->
<div
  id="add-photos-modal"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-1 sm:p-2 md:p-3 lg:p-4 hidden z-50"
>
  <div
    class="bg-white rounded-md sm:rounded-lg md:rounded-xl lg:rounded-2xl shadow-2xl p-3 sm:p-4 md:p-5 lg:p-6 w-full max-w-xs sm:max-w-sm md:max-w-md"
  >
    <h2
      class="text-base sm:text-lg md:text-xl lg:text-2xl font-bold text-gray-900 text-center mb-2 sm:mb-3 md:mb-4 lg:mb-6"
    >
      Upload More Photos
    </h2>
    <form
      id="add-photos-form"
      method="POST"
      action="{{ url_for('add_photos') }}"
      enctype="multipart/form-data"
    >
      <div
        class="grid grid-cols-2 sm:grid-cols-3 gap-1 sm:gap-1.5 md:gap-2 lg:gap-3"
        id="modal-photos-grid"
      >
        <label
          for="modal-photos-input"
          id="modal-upload-label"
          class="cursor-pointer h-16 sm:h-20 md:h-24 lg:h-32 border-2 border-dashed border-gray-300 rounded-md sm:rounded-lg flex flex-col items-center justify-center hover:border-yellow-500 transition-colors"
        >
          <i
            data-lucide="upload"
            class="h-3 w-3 sm:h-4 sm:w-4 md:h-6 md:w-6 lg:h-8 lg:w-8 text-gray-400 mb-1 sm:mb-2"
          ></i>
          <span class="text-gray-500 text-[10px] sm:text-xs"
            >Click to upload</span
          >
        </label>
      </div>
      <input
        type="file"
        name="photos"
        id="modal-photos-input"
        accept="image/*"
        multiple
        class="hidden"
      />
      <div
        class="flex justify-end mt-2 sm:mt-3 md:mt-4 lg:mt-6 space-x-1 sm:space-x-2 md:space-x-3 lg:space-x-4"
      >
        <button
          type="button"
          id="cancel-upload-btn"
          class="px-2 sm:px-3 md:px-4 lg:px-6 py-1 sm:py-1.5 md:py-2 text-gray-600 hover:text-yellow-600 transition-colors text-xs sm:text-sm md:text-base"
        >
          Cancel
        </button>
        <button
          type="submit"
          class="px-2 sm:px-3 md:px-4 lg:px-6 py-1 sm:py-1.5 md:py-2 bg-gradient-to-r from-yellow-500 to-orange-600 text-white rounded-md sm:rounded-lg font-semibold hover:from-yellow-600 hover:to-orange-700 text-xs sm:text-sm md:text-base"
        >
          Upload
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Popup Modal -->
<div
  id="popup-modal"
  class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-1 sm:p-2 md:p-3 lg:p-4 z-50 transition-opacity"
>
  <div
    class="bg-white rounded-md sm:rounded-lg md:rounded-xl lg:rounded-2xl shadow-2xl w-full max-w-xs sm:max-w-sm md:max-w-md max-h-[70vh] sm:max-h-[75vh] md:max-h-[80vh] flex flex-col transform transition-all scale-95"
  >
    <!-- Header -->
    <div
      class="flex justify-between items-center border-b p-1.5 sm:p-2 md:p-3 lg:p-4 sticky top-0 bg-white rounded-t-md sm:rounded-t-lg md:rounded-t-xl lg:rounded-t-2xl"
    >
      <h2
        id="popup-title"
        class="text-xs sm:text-sm md:text-base lg:text-xl font-bold text-gray-900"
      ></h2>
      <button
        onclick="closePopup()"
        class="text-gray-500 hover:text-gray-800 transition p-0.5"
      >
        <i
          data-lucide="x"
          class="h-3 w-3 sm:h-4 sm:w-4 md:h-5 md:w-5 lg:h-6 lg:w-6"
        ></i>
      </button>
    </div>
    <!-- Scrollable Content -->
    <div
      id="popup-list"
      class="flex-1 overflow-y-auto p-1.5 sm:p-2 md:p-3 lg:p-4 space-y-1 sm:space-y-2 md:space-y-3 lg:space-y-4"
    >
      <p class="text-gray-500 text-xs sm:text-sm md:text-base">Loading...</p>
    </div>
    <!-- Footer -->
    <div class="border-t p-1.5 sm:p-2 md:p-3 lg:p-4">
      <button
        onclick="closePopup()"
        class="w-full py-1 sm:py-1.5 md:py-2 lg:py-2.5 bg-gradient-to-r from-yellow-500 to-orange-600 text-white rounded-md sm:rounded-lg font-semibold hover:from-yellow-600 hover:to-orange-700 transition-all text-xs sm:text-sm md:text-base"
      >
        Close
      </button>
    </div>
  </div>
</div>

<!-- Lightbox Modal -->
<div
  id="lightbox-modal"
  class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-1 sm:p-2 md:p-3 lg:p-4 hidden z-50"
>
  <span
    id="close-lightbox"
    class="absolute top-1 sm:top-2 md:top-3 lg:top-4 right-1 sm:right-2 md:right-3 lg:right-4 text-white text-xl sm:text-2xl lg:text-3xl cursor-pointer"
    >&times;</span
  >
  <img
    id="lightbox-image"
    src=""
    class="max-w-full max-h-full rounded-md sm:rounded-lg md:rounded-xl"
  />
</div>

<script>
  function openPopup(type) {
    const modal = document.getElementById("popup-modal");
    const title = document.getElementById("popup-title");
    const list = document.getElementById("popup-list");
    let url = "";
    if (type === "matches") {
      url = "/get_matches";
      title.textContent = "People Who Matched You";
    } else if (type === "messages") {
      url = "/get_message_partners";
      title.textContent = "People You Messaged";
    } else if (type === "likes") {
      url = "/get_likes";
      title.textContent = "People Who Liked You";
    }
    list.innerHTML =
      "<p class='text-gray-500 text-xs sm:text-sm md:text-base'>Loading...</p>";
    modal.classList.remove("hidden");
    modal.classList.add("flex");
    fetch(url)
      .then((res) => res.json())
      .then((users) => {
        if (!users.length) {
          list.innerHTML =
            "<p class='text-gray-500 text-xs sm:text-sm md:text-base'>No users found.</p>";
          return;
        }
        list.innerHTML = "";
        users.forEach((user) => {
          const photo =
            user.photos && user.photos.length
              ? user.photos[0]
              : "https://images.pexels.com/photos/220453/pexels-photo-220453.jpeg?auto=compress&cs=tinysrgb&w=400&h=400&fit=crop&crop=face";
          const div = document.createElement("div");
          div.className =
            "flex items-center space-x-1 sm:space-x-2 md:space-x-3";
          div.innerHTML = `
            <a href="/profile/${user.id}" class="flex items-center space-x-1 sm:space-x-2 md:space-x-3 w-full">
              <img src="${photo}" class="w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 lg:w-14 lg:h-14 rounded-full object-cover">
              <span class="font-medium text-gray-800 hover:text-yellow-500 transition-colors text-xs sm:text-sm md:text-base">${user.name}</span>
            </a>
          `;
          list.appendChild(div);
        });
      });
  }

  function closePopup() {
    const modal = document.getElementById("popup-modal");
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  }

  document.addEventListener("DOMContentLoaded", function () {
    const activityList = document.getElementById("recent-activity-list");
    const toggleBtn = document.getElementById("toggle-activity-btn");
    if (activityList && toggleBtn) {
      activityList.classList.add("max-h-40", "overflow-hidden");
      toggleBtn.addEventListener("click", function () {
        const isExpanded = activityList.classList.toggle("max-h-40");
        activityList.classList.toggle("overflow-hidden");
        toggleBtn.textContent = isExpanded ? "Show More" : "Show Less";
      });
    }

    const addPhotosBtn = document.getElementById("add-photos-btn");
    const addPhotosModal = document.getElementById("add-photos-modal");
    const cancelUploadBtn = document.getElementById("cancel-upload-btn");
    const modalPhotosInput = document.getElementById("modal-photos-input");
    const modalPhotosGrid = document.getElementById("modal-photos-grid");
    const modalUploadLabel = document.getElementById("modal-upload-label");
    const addPhotosForm = document.getElementById("add-photos-form");
    const uploadBtn = addPhotosForm.querySelector("button[type='submit']");

    // Open modal & reset previews
    addPhotosBtn.addEventListener("click", () => {
      addPhotosModal.classList.remove("hidden");
      modalPhotosGrid
        .querySelectorAll(".photo-preview")
        .forEach((el) => el.remove());
      modalPhotosInput.value = "";
      uploadBtn.disabled = false;
      uploadBtn.classList.remove("opacity-50", "cursor-not-allowed");
    });

    // Cancel modal
    cancelUploadBtn.addEventListener("click", () => {
      addPhotosModal.classList.add("hidden");
    });

    // Handle photo previews
    modalPhotosInput.addEventListener("change", () => {
      modalPhotosGrid
        .querySelectorAll(".photo-preview")
        .forEach((el) => el.remove());
      const files = modalPhotosInput.files;
      if (files.length > 5) {
        alert("You can only upload a maximum of 5 photos at a time.");
        modalPhotosInput.value = "";
        return;
      }
      for (const file of files) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const div = document.createElement("div");
          div.className = "relative photo-preview";
          div.innerHTML = `<img src="${e.target.result}" class="w-full h-16 sm:h-20 md:h-24 lg:h-32 object-cover rounded-md sm:rounded-lg">`;
          modalPhotosGrid.insertBefore(div, modalUploadLabel);
        };
        reader.readAsDataURL(file);
      }
    });

    // Disable upload button after click to prevent multiple submissions
    addPhotosForm.addEventListener("submit", function () {
      if (!modalPhotosInput.files.length) {
        alert("Please select at least one photo.");
        return false; // Prevent submission
      }
      uploadBtn.disabled = true;
      uploadBtn.classList.add("opacity-50", "cursor-not-allowed");
    });

    // Lightbox
    const lightboxModal = document.getElementById("lightbox-modal");
    const lightboxImage = document.getElementById("lightbox-image");
    const closeLightbox = document.getElementById("close-lightbox");

    window.openLightbox = function (src) {
      lightboxImage.src = src;
      lightboxModal.classList.remove("hidden");
      // Prevent body scrolling when modal is open
      document.body.style.overflow = "hidden";
    };

    closeLightbox.addEventListener("click", () => {
      lightboxModal.classList.add("hidden");
      // Restore body scrolling
      document.body.style.overflow = "auto";
    });

    // Close modals when clicking outside
    window.addEventListener("click", (event) => {
      if (event.target === addPhotosModal) {
        addPhotosModal.classList.add("hidden");
      }
      if (event.target === document.getElementById("popup-modal")) {
        closePopup();
      }
      if (event.target === lightboxModal) {
        lightboxModal.classList.add("hidden");
        document.body.style.overflow = "auto";
      }
    });

    // Close lightbox with Escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        if (!lightboxModal.classList.contains("hidden")) {
          lightboxModal.classList.add("hidden");
          document.body.style.overflow = "auto";
        }
        if (!addPhotosModal.classList.contains("hidden")) {
          addPhotosModal.classList.add("hidden");
        }
        if (
          !document.getElementById("popup-modal").classList.contains("hidden")
        ) {
          closePopup();
        }
      }
    });
  });
</script>
{% endblock %}
