{% extends "base.html" %} {% block content %}
<style>
  /* Base Styles for the cards and buttons */
  .profile-card-container,
  .match-card-container {
    transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
  }
  .fade-out {
    opacity: 0;
    transform: translateY(-20px);
  }
  .fade-in {
    opacity: 1;
    transform: translateY(0);
  }

  /* Specific styles for the match card to make it pop */
  #match-card {
    background: linear-gradient(135deg, #ff69b4, #ffb6c1);
    animation: pulse 1.5s infinite;
  }
  @keyframes pulse {
    0% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.05);
    }
    100% {
      transform: scale(1);
    }
  }

  /* Style for the profile image with overlay */
  .profile-image-container {
    position: relative;
    width: 100%;
    height: 350px;
    background: #f3f3f3;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .profile-image-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: none; /* initially hidden until loaded */
  }
  .profile-image-container::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 50%;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
  }

  /* Skeleton loader */
  .skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e4e4e4 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s infinite;
  }
  @keyframes skeleton-loading {
    0% {
      background-position: 200% 0;
    }
    100% {
      background-position: -200% 0;
    }
  }
</style>

<div class="flex justify-center items-center h-screen bg-gradient-to-br from-orange-100 via-orange-200 to-orange-300 p-4">

  <div id="no-profiles" class="text-gray-600 text-center text-xl hidden">
    No profiles available. Try again later!
  </div>
  <!-- Loader -->
  <div
    id="loader"
    class="hidden fixed inset-0 flex items-center justify-center bg-white bg-opacity-70 z-50"
  >
    <div
      class="animate-spin rounded-full h-16 w-16 border-t-4 border-yellow-500 border-solid"
    ></div>
  </div>

  <!-- Back Button -->
  <div class="absolute top-6 left-6">
    <button
      onclick="window.location.href='/dashboard'"
      class="flex items-center bg-gray-200 text-gray-700 px-4 py-2 rounded-xl shadow hover:bg-gray-300 transition"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-5 w-5 mr-2"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M15 19l-7-7 7-7"
        />
      </svg>
      Back to Dashboard
    </button>
  </div>

  <div
    id="profile-card"
    class="relative bg-white rounded-2xl shadow-xl w-full max-w-sm overflow-hidden transform scale-100 opacity-100 border-4 border-grey"
  >
    <div class="profile-image-container rounded-t-2xl">
      <div id="profile-pic-skeleton" class="skeleton absolute inset-0"></div>
      <img
        id="profile-pic"
        src=""
        alt="Profile Picture"
        class="rounded-t-2xl"
      />
    </div>
    <div class="p-6">
      <h2 id="profile-name" class="text-3xl font-bold text-gray-900"></h2>
      <p id="profile-age" class="text-gray-600 text-lg"></p>
      <p id="profile-bio" class="mt-4 text-sm text-gray-800"></p>

      <div class="flex justify-between mt-6 px-4">
        <button
          onclick="passProfile()"
          class="bg-white text-gray-500 rounded-full w-14 h-14 flex items-center justify-center shadow-lg transform transition-transform hover:scale-110 hover:bg-gray-100 focus:outline-none"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-8 w-8 text-gray-400"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
        <button
          onclick="likeProfile()"
          class="bg-white text-yellow-500 rounded-full w-14 h-14 flex items-center justify-center shadow-lg transform transition-transform hover:scale-110 hover:bg-yellow-100 focus:outline-none"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-8 w-8 text-yellow-500"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"
              clip-rule="evenodd"
            />
          </svg>
        </button>
      </div>

      <div class="mt-6 text-center">
        <a
          id="view-full-profile"
          href="#"
          class="inline-block bg-gray-200 text-gray-800 text-sm px-4 py-2 rounded-full font-semibold hover:bg-gray-300 transition-colors"
        >
          View Full Profile
        </a>
      </div>
    </div>
  </div>

  <div
    id="match-card"
    class="fixed inset-0 bg-black bg-opacity-75 flex flex-col justify-center items-center z-50 hidden"
  >
    <div
      class="bg-white p-8 rounded-3xl shadow-2xl text-center relative max-w-sm mx-auto"
    >
      <h2 class="text-4xl font-extrabold text-white">It's a Match!</h2>
      <div class="flex justify-center items-center my-6 relative">
        <img
          id="match-user-pic"
          src=""
          alt="Your Profile"
          class="w-24 h-24 rounded-full border-4 border-white object-cover shadow-lg"
        />
        <img
          id="match-other-pic"
          src=""
          alt="Matched User"
          class="w-24 h-24 rounded-full border-4 border-white object-cover shadow-lg -ml-4"
        />
        <div
          class="absolute z-10 text-4xl transform -translate-x-1/2 left-1/2 text-white"
        >
          ❤️
        </div>
      </div>
      <p class="text-xl font-semibold text-white mb-4">
        You and <span id="match-name" class="font-bold"></span> have liked each
        other!
      </p>
      <div class="flex justify-center space-x-4">
        <button
          onclick="closeMatchCard()"
          class="bg-yellow-500 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-yellow-600 transition-colors"
        >
          Keep Swiping
        </button>
        <a
          id="chat-link"
          href="#"
          class="bg-white text-yellow-500 font-bold py-3 px-6 rounded-full shadow-lg hover:bg-gray-200 transition-colors"
        >
          Send a Message
        </a>
      </div>
    </div>
  </div>
</div>

<script>
  let currentProfile = null;
  let nextProfileCache = null;

  async function fetchProfile(endpoint = "/next-profile") {
    const res = await fetch(endpoint);
    if (res.ok) {
      return await res.json();
    }
    return null;
  }

  async function prefetchNext() {
    try {
      const data = await fetchProfile();
      if (data && !data.error) {
        nextProfileCache = data;
      } else {
        nextProfileCache = null;
      }
    } catch (err) {
      console.error("Prefetch error:", err);
      nextProfileCache = null;
    }
  }

  async function fetchNextProfile() {
    const loader = document.getElementById("loader");
    loader.classList.remove("hidden"); // show loader

    try {
      let data;

      if (nextProfileCache) {
        // use pre-fetched profile
        data = nextProfileCache;
        nextProfileCache = null;
        prefetchNext(); // fetch another in background
      } else {
        data = await fetchProfile();
        if (!data || data.error) {
          document.getElementById("profile-card").classList.add("hidden");
          document.getElementById("no-profiles").classList.remove("hidden");
          return;
        }
        prefetchNext(); // start prefetching next
      }

      currentProfile = data;
      const profileCard = document.getElementById("profile-card");
      const noProfiles = document.getElementById("no-profiles");

      profileCard.classList.remove("hidden");
      noProfiles.classList.add("hidden");

      // preload image before showing
      const img = document.getElementById("profile-pic");
      const skeleton = document.getElementById("profile-pic-skeleton");
      img.style.display = "none";
      skeleton.classList.remove("hidden");

      const preloader = new Image();
      preloader.src =
        data.profile_picture ||
        "{{ url_for('static', filename='default-pic.png') }}";
      preloader.onload = () => {
        img.src = preloader.src;
        skeleton.classList.add("hidden");
        img.style.display = "block";

        document.getElementById("profile-name").innerText = data.name;
        document.getElementById("profile-age").innerText = data.age
          ? `${data.age}`
          : "";
        document.getElementById("profile-bio").innerText = data.bio || "";
        document.getElementById(
          "view-full-profile"
        ).href = `/profile/${data.id}`;
      };
    } catch (err) {
      console.error("Error fetching profile:", err);
    } finally {
      loader.classList.add("hidden"); // hide loader
    }
  }

  async function likeProfile() {
    if (!currentProfile) return;
    const res = await fetch(`/like2/${currentProfile.id}`, { method: "POST" });
    const data = await res.json();
    console.log("Like result:", data);

    if (data.match) {
      document.getElementById("match-card").classList.remove("hidden");
      document.getElementById("match-user-pic").src = data.current_user_pic;
      document.getElementById("match-other-pic").src = data.matched_user_pic;
      document.getElementById("match-name").innerText = currentProfile.name;
      document.getElementById("chat-link").href = `/chat/${currentProfile.id}`;
    } else {
      fetchNextProfile(); // show next one if no match
    }
  }

  function passProfile() {
    fetchNextProfile(); // just skip
  }

  function closeMatchCard() {
    document.getElementById("match-card").classList.add("hidden");
    fetchNextProfile();
  }

  // load first profile
  fetchNextProfile();
</script>
{% endblock %}

